#
# Hand-crafted FEA code
#

languagesystem DFLT dflt;
languagesystem lepc dflt;


#********************************************
# Font rendering check
#
# The following three lookups change "RenderingUnknown" to "RenderingOpenType"

lookup _FontCheck_Unknow {
  lookupflag IgnoreMarks;
    sub [U n k o w ] by [O p e T y];
} _FontCheck_Unknow;

lookup _FontCheck_n {
  lookupflag IgnoreMarks;
    sub n by p e;
} _FontCheck_n;

lookup FontCheck {
  lookupflag IgnoreMarks ;
    sub [R] e n d e r i n g 
      U' lookup _FontCheck_Unknow 
      n' lookup _FontCheck_Unknow
      k' lookup _FontCheck_Unknow
      n'  
      o' lookup _FontCheck_Unknow 
      w' lookup _FontCheck_Unknow 
      n' lookup _FontCheck_n;
} FontCheck;


#********************************************
# Substitution lookups
#

# Move final mark onto Vtl ligature
# This should be done before built-in OT reordering.

@MarksOnVtl =  [ uni1C2D      uni1C2E    uni1C2F     uni1C30     uni1C31     uni1C32     uni1C33     uni1C35     ] ;
@VtlPlusMark = [ uni1C291C2D uni1C291C2E uni1C291C2F uni1C291C30 uni1C291C31 uni1C291C32 uni1C291C33 uni1C291C35 ] ;

lookup VtlMarkLig {
		sub uni1C29'  @MarksOnVtl' by  @VtlPlusMark;
} VtlMarkLig ;


#--- Ra/Ya ligatures ---

@Cons =   [  #uni25CC
		uni1C00  uni1C01  uni1C02  uni1C03  uni1C04  uni1C05  uni1C06  uni1C07  uni1C08
		uni1C09  uni1C0A  uni1C0B  uni1C0C  uni1C0D  uni1C0E  uni1C0F  uni1C10  uni1C11  uni1C12
		uni1C13  uni1C14  uni1C15  uni1C16  uni1C17  uni1C18  uni1C19  uni1C1A  uni1C1B  uni1C1C
		uni1C1D  uni1C1E  uni1C1F  uni1C20  uni1C21  uni1C22  uni1C23  uni1C4D  uni1C4E  uni1C4F ] ;

@TakesYa = [
		uni1C00      uni1C01      uni1C02      uni1C03      uni1C04      uni1C05      uni1C0A      uni1C0B
    uni1C0C      uni1C0E      uni1C0F      uni1C10      uni1C11      uni1C12      uni1C13      uni1C14  
    uni1C15      uni1C16      uni1C1B      uni1C1C      uni1C1D      uni1C1E      uni1C1F      uni1C21      uni1C23 ] ;
@BasePlusYa = [
		uni1C001C24  uni1C011C24  uni1C021C24  uni1C031C24  uni1C041C24  uni1C051C24  uni1C0A1C24  uni1C0B1C24
    uni1C0C1C24  uni1C0E1C24  uni1C0F1C24  uni1C101C24  uni1C111C24  uni1C121C24  uni1C131C24  uni1C141C24
    uni1C151C24  uni1C161C24  uni1C1B1C24  uni1C1C1C24  uni1C1D1C24  uni1C1E1C24  uni1C1F1C24  uni1C211C24  uni1C231C24 ] ;

@TakesRaAndRaYa = [ 
    uni1C00          uni1C03          uni1C05          uni1C0E          uni1C11
    uni1C13          uni1C15          uni1C1D ] ;
@BasePlusRa =     [
    uni1C001C25      uni1C031C25      uni1C051C25      uni1C0E1C25      uni1C111C25
    uni1C131C25      uni1C151C25      uni1C1D1C25 ] ;
@BasePlusRaYa =  [
    uni1C001C251C24  uni1C031C251C24  uni1C051C251C24  uni1C0E1C251C24  uni1C111C251C24
    uni1C131C251C24  uni1C151C251C24  uni1C1D1C251C24 ] ;
    
lookup RaYaLigatures {

	lookupflag IgnoreMarks;
  	sub @TakesYa         uni1C24           by  @BasePlusYa ;
  	sub @TakesRaAndRaYa  uni1C25           by  @BasePlusRa ;
  	sub @TakesRaAndRaYa  uni1C25  uni1C24  by  @BasePlusRaYa ;
  	
} RaYaLigatures;


@ConsAll = [ @Cons  @BasePlusYa  @BasePlusRa  @BasePlusRaYa ];

@N = [ uni1C37 ] ;
@Ran   = [ uni1C36 ] ;

@VtlAll = [ uni1C29  uni1C291C2D uni1C291C2E uni1C291C2F uni1C291C30 uni1C291C31 uni1C291C32 uni1C291C33 uni1C291C35 ] ;  # top-left vowel & mark ligatures

@Left = [ @VtlAll  uni1C27  uni1C28  uni1C34  uni1C35 ] ;

@Vright = [ uni1C26  uni1C2A  uni1C2B ];

@LKludge = [ uni1C2B ];  # for debugging reordering using hb-shape, for reordered glyphs that work correctly there but not in other places
##@LKludge = [ uni1C27 ] ;


#--- Reorder Kang - KLUDGE needed for InDesign ---

# Delete the original vowel (and ran) that has now been moved to the left.
lookup _del_extra {
		sub      @ConsAll' @Left' @Ran' by  @ConsAll;
		sub @Ran @ConsAll' @Left'       by  @ConsAll;
		sub      @ConsAll' @Left'       by  @ConsAll;
		sub           @Vright' uni1C35' by  @Vright;
} _del_extra ;



lookup _ins_Kang { sub @ConsAll  by  uni1C35  @ConsAll; } _ins_Kang ;

lookup Reorder_CryNVK {

	# C V K -> K C V K -> K C V
	sub  @ConsAll' lookup _ins_Kang  @Vright'  uni1C35'  lookup _del_extra ;

} Reorder_CryNVK ;


#--- Reorder top-left vowel ---

# This should be done automatically by the engine but not all do.



# C  -> V C
lookup _ins_Vtl     { sub @ConsAll  by  uni1C29      @ConsAll; } _ins_Vtl ;
lookup _ins_Vtl1C2D { sub @ConsAll  by  uni1C291C2D  @ConsAll; } _ins_Vtl1C2D ;
lookup _ins_Vtl1C2E { sub @ConsAll  by  uni1C291C2E  @ConsAll; } _ins_Vtl1C2E ;
lookup _ins_Vtl1C2F { sub @ConsAll  by  uni1C291C2F  @ConsAll; } _ins_Vtl1C2F ;
lookup _ins_Vtl1C30 { sub @ConsAll  by  uni1C291C30  @ConsAll; } _ins_Vtl1C30 ;
lookup _ins_Vtl1C31 { sub @ConsAll  by  uni1C291C31  @ConsAll; } _ins_Vtl1C31 ;
lookup _ins_Vtl1C32 { sub @ConsAll  by  uni1C291C32  @ConsAll; } _ins_Vtl1C32 ;
lookup _ins_Vtl1C33 { sub @ConsAll  by  uni1C291C33  @ConsAll; } _ins_Vtl1C33 ;
lookup _ins_Vtl1C35 { sub @ConsAll  by  uni1C291C35  @ConsAll; } _ins_Vtl1C35 ;
lookup _ins_V1C27   { sub @ConsAll  by  @LKludge      @ConsAll; } _ins_V1C27 ;
lookup _ins_V1C28   { sub @ConsAll  by  uni1C28      @ConsAll; } _ins_V1C28 ;
lookup _ins_Cs1C34  { sub @ConsAll  by  uni1C34      @ConsAll; } _ins_Cs1C34 ;  # cons sign
lookup _ins_Cs1C35  { sub @ConsAll  by  uni1C35      @ConsAll; } _ins_Cs1C35 ;  # cons sign

# C  -> V C V
lookup _dbl_Vtl     { sub @ConsAll  by  uni1C29      @ConsAll  uni1C29;        } _dbl_Vtl ;
lookup _dbl_Vtl1C2D { sub @ConsAll  by  uni1C291C2D  @ConsAll  uni1C291C2D; } _dbl_Vtl1C2D ;
lookup _dbl_Vtl1C2E { sub @ConsAll  by  uni1C291C2E  @ConsAll  uni1C291C2E; } _dbl_Vtl1C2E ;
lookup _dbl_Vtl1C2F { sub @ConsAll  by  uni1C291C2F  @ConsAll  uni1C291C2F; } _dbl_Vtl1C2F ;
lookup _dbl_Vtl1C30 { sub @ConsAll  by  uni1C291C30  @ConsAll  uni1C291C30; } _dbl_Vtl1C30 ;
lookup _dbl_Vtl1C31 { sub @ConsAll  by  uni1C291C31  @ConsAll  uni1C291C31; } _dbl_Vtl1C31 ;
lookup _dbl_Vtl1C32 { sub @ConsAll  by  uni1C291C32  @ConsAll  uni1C291C32; } _dbl_Vtl1C32 ;
lookup _dbl_Vtl1C33 { sub @ConsAll  by  uni1C291C33  @ConsAll  uni1C291C33; } _dbl_Vtl1C33 ;
lookup _dbl_Vtl1C35 { sub @ConsAll  by  uni1C291C35  @ConsAll  uni1C291C35; } _dbl_Vtl1C35 ;
lookup _dbl_V1C27   { sub @ConsAll  by  @LKludge      @ConsAll  @LKludge;     } _dbl_V1C27 ;
lookup _dbl_V1C28   { sub @ConsAll  by  uni1C28      @ConsAll  uni1C28;     } _dbl_V1C28 ;
lookup _dbl_Cs1C34  { sub @ConsAll  by  uni1C34      @ConsAll  uni1C34;     } _dbl_Cs1C34 ;  # cons sign
lookup _dbl_Cs1C35  { sub @ConsAll  by  uni1C35      @ConsAll  uni1C35;     } _dbl_Cs1C35 ;  # cons sign

# C  ->  V R C
lookup _ins_VtlRan     { sub @ConsAll  by  uni1C29      @Ran  @ConsAll; } _ins_VtlRan ;
lookup _ins_Vtl1C2DRan { sub @ConsAll  by  uni1C291C2D  @Ran  @ConsAll; } _ins_Vtl1C2DRan ;
lookup _ins_Vtl1C2ERan { sub @ConsAll  by  uni1C291C2E  @Ran  @ConsAll; } _ins_Vtl1C2ERan ;
lookup _ins_Vtl1C2FRan { sub @ConsAll  by  uni1C291C2F  @Ran  @ConsAll; } _ins_Vtl1C2FRan ;
lookup _ins_Vtl1C30Ran { sub @ConsAll  by  uni1C291C30  @Ran  @ConsAll; } _ins_Vtl1C30Ran ;
lookup _ins_Vtl1C31Ran { sub @ConsAll  by  uni1C291C31  @Ran  @ConsAll; } _ins_Vtl1C31Ran ;
lookup _ins_Vtl1C32Ran { sub @ConsAll  by  uni1C291C32  @Ran  @ConsAll; } _ins_Vtl1C32Ran ;
lookup _ins_Vtl1C33Ran { sub @ConsAll  by  uni1C291C33  @Ran  @ConsAll; } _ins_Vtl1C33Ran ;
lookup _ins_Vtl1C35Ran { sub @ConsAll  by  uni1C291C35  @Ran  @ConsAll; } _ins_Vtl1C35Ran ;
lookup _ins_V1C27Ran   { sub @ConsAll  by  @LKludge      @Ran  @ConsAll; } _ins_V1C27Ran ;
lookup _ins_V1C28Ran   { sub @ConsAll  by  uni1C28      @Ran  @ConsAll; } _ins_V1C28Ran ;
lookup _ins_Cs1C34Ran  { sub @ConsAll  by  uni1C34      @Ran  @ConsAll; } _ins_Cs1C34Ran ;  # cons sign
lookup _ins_Cs1C35Ran  { sub @ConsAll  by  uni1C35      @Ran  @ConsAll; } _ins_Cs1C35Ran ;  # cons sign

# C  ->  V R C V
lookup _dbl_VtlRan     { sub @ConsAll  by  uni1C29      @Ran  @ConsAll  uni1C29;        } _dbl_VtlRan ;
lookup _dbl_Vtl1C2DRan { sub @ConsAll  by  uni1C291C2D  @Ran  @ConsAll  uni1C291C2D; } _dbl_Vtl1C2DRan ;
lookup _dbl_Vtl1C2ERan { sub @ConsAll  by  uni1C291C2E  @Ran  @ConsAll  uni1C291C2E; } _dbl_Vtl1C2ERan ;
lookup _dbl_Vtl1C2FRan { sub @ConsAll  by  uni1C291C2F  @Ran  @ConsAll  uni1C291C2F; } _dbl_Vtl1C2FRan ;
lookup _dbl_Vtl1C30Ran { sub @ConsAll  by  uni1C291C30  @Ran  @ConsAll  uni1C291C30; } _dbl_Vtl1C30Ran ;
lookup _dbl_Vtl1C31Ran { sub @ConsAll  by  uni1C291C31  @Ran  @ConsAll  uni1C291C31; } _dbl_Vtl1C31Ran ;
lookup _dbl_Vtl1C32Ran { sub @ConsAll  by  uni1C291C32  @Ran  @ConsAll  uni1C291C32; } _dbl_Vtl1C32Ran ;
lookup _dbl_Vtl1C33Ran { sub @ConsAll  by  uni1C291C33  @Ran  @ConsAll  uni1C291C33; } _dbl_Vtl1C33Ran ;
lookup _dbl_Vtl1C35Ran { sub @ConsAll  by  uni1C291C35  @Ran  @ConsAll  uni1C291C35; } _dbl_Vtl1C35Ran ;
lookup _dbl_V1C27Ran   { sub @ConsAll  by  @LKludge      @Ran  @ConsAll  @LKludge;     } _dbl_V1C27Ran ;
lookup _dbl_V1C28Ran   { sub @ConsAll  by  uni1C28      @Ran  @ConsAll  uni1C28;     } _dbl_V1C28Ran ;
lookup _dbl_Cs1C34Ran  { sub @ConsAll  by  uni1C34      @Ran  @ConsAll  uni1C34;     } _dbl_Cs1C34Ran ;  # cons sign
lookup _dbl_Cs1C35Ran  { sub @ConsAll  by  uni1C35      @Ran  @ConsAll  uni1C35;     } _dbl_Cs1C35Ran ;  # cons sign

lookup _delete_dup {
	sub  @N  @Left  @Ran  by  @N ;
  sub  @N  @Left        by  @N ;  # this won't work when the nukta was in a cons cluster, see kludge in Reorder_CryNV_delV
} _delete_dup ;


# put longer rules first - those including the Ran
lookup Reorder_CryNVR {

  # C V R -> V R C V -> V R C
	sub  @ConsAll' lookup _ins_VtlRan      uni1C29'       @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2DRan  uni1C291C2D'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2ERan  uni1C291C2E'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2FRan  uni1C291C2F'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C30Ran  uni1C291C30'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C31Ran  uni1C291C31'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C32Ran  uni1C291C32'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C33Ran  uni1C291C33'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C35Ran  uni1C291C35'   @Ran' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_V1C27Ran    @LKludge'       @Ran' lookup _del_extra ;
	sub  @ConsAll' lookup _ins_V1C28Ran    uni1C28'       @Ran' lookup _del_extra ;
	sub  @ConsAll' lookup _ins_Cs1C34Ran   uni1C34'       @Ran' lookup _del_extra ;  # cons sign
	sub  @ConsAll' lookup _ins_Cs1C35Ran   uni1C35'       @Ran' lookup _del_extra ;  # cons sign

  
  # C N V R -> V R C V N V R -> V R C N V R -> V C N
  sub  @ConsAll' lookup _dbl_VtlRan      @N'  uni1C29'     lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2DRan  @N'  uni1C291C2D' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2ERan  @N'  uni1C291C2E' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2FRan  @N'  uni1C291C2F' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C30Ran  @N'  uni1C291C30' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C31Ran  @N'  uni1C291C31' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C32Ran  @N'  uni1C291C32' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C33Ran  @N'  uni1C291C33' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C35Ran  @N'  uni1C291C35' lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_V1C27Ran    @N'  @LKludge'     lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_V1C28Ran    @N'  uni1C28'     lookup _del_extra  @Ran' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Cs1C34Ran   @N'  uni1C34'     lookup _del_extra  @Ran' lookup _delete_dup ;  # cons sign
	sub  @ConsAll' lookup _dbl_Cs1C35Ran   @N'  uni1C35'     lookup _del_extra  @Ran' lookup _delete_dup ;  # cons sign
 
} Reorder_CryNVR ;

lookup Reorder_CryNV {

  # C V -> V C V -> V C
	sub  @ConsAll' lookup _ins_Vtl      uni1C29'     lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2D  uni1C291C2D' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2E  uni1C291C2E' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C2F  uni1C291C2F' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C30  uni1C291C30' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C31  uni1C291C31' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C32  uni1C291C32' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C33  uni1C291C33' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Vtl1C35  uni1C291C35' lookup _del_extra ;
  sub  @ConsAll' lookup _ins_V1C27    @LKludge'     lookup _del_extra ;
  sub  @ConsAll' lookup _ins_V1C28    uni1C28'     lookup _del_extra ;
  sub  @ConsAll' lookup _ins_Cs1C34   uni1C34'     lookup _del_extra ;  # cons sign
  sub  @ConsAll' lookup _ins_Cs1C35   uni1C35'     lookup _del_extra ;  # cons sign
    
  # C N V -> V C V N V -> V C N V -> V C N
  sub  @ConsAll' lookup _dbl_Vtl      @N' lookup _del_extra  uni1C29'        lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2D  @N' lookup _del_extra  uni1C291C2D' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2E  @N' lookup _del_extra  uni1C291C2E' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C2F  @N' lookup _del_extra  uni1C291C2F' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C30  @N' lookup _del_extra  uni1C291C30' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C31  @N' lookup _del_extra  uni1C291C31' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C32  @N' lookup _del_extra  uni1C291C32' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C33  @N' lookup _del_extra  uni1C291C33' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Vtl1C35  @N' lookup _del_extra  uni1C291C35' lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_V1C27    @N' lookup _del_extra  @LKludge'     lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_V1C28    @N' lookup _del_extra  uni1C28'     lookup _delete_dup ;
  sub  @ConsAll' lookup _dbl_Cs1C34   @N' lookup _del_extra  uni1C34'     lookup _delete_dup ;  # cons sign
  sub  @ConsAll' lookup _dbl_Cs1C35   @N' lookup _del_extra  uni1C35'     lookup _delete_dup ;  # cons sign
  
	# I don't think we ever need this because the mark never goes before the vowel.
  #sub @ConsAll' lookup dbl_Vtl  @N' lookup del_extra  @M' uni1C29' lookup delete_dup ;

} Reorder_CryNV ;

@M = [ uni1C2D  uni1C2E  uni1C2F  uni1C30  uni1C31  uni1C32  uni1C33 ] ;
@BogusNull = [ uni2219 ] ;

lookup Reorder_CryNV_delV {

	sub @Left'  @M'  by  @M ;
	
	# When the nuqta was in the middle of what is now a ligature, we can't do N+V -> N to delete the left-side V/sign.
	# So instead we replace just the vowel/sign with a bogus null glyph.
	# IT IS RISKY TO INCLUDE BOGUS GLYPHS, so be sure to take this out again at the end of the process.
	do  for v = @Left;
		  { sub @N  $v' @Ran' by  @BogusNull ; }
	sub  @N  @Left'  by  @BogusNull ;
	
} Reorder_CryNV_delV ;


#--- Reorder top mark and right-side vowel ---

# This is necessary for the mark to be attached to the preceding consonant.

####@Vright = [ uni1C26  uni1C2A  uni1C2B ];
@Mtop = [ uni1C2D  uni1C2E  uni1C2F  uni1C30  uni1C31  uni1C32  uni1C33  uni1C36 ];

lookup _insM1C2D { sub  @Vright  by  uni1C2D  @Vright ; } _insM1C2D ;
lookup _insM1C2E { sub  @Vright  by  uni1C2E  @Vright ; } _insM1C2E ;
lookup _insM1C2F { sub  @Vright  by  uni1C2F  @Vright ; } _insM1C2F ;
lookup _insM1C30 { sub  @Vright  by  uni1C30  @Vright ; } _insM1C30 ;
lookup _insM1C31 { sub  @Vright  by  uni1C31  @Vright ; } _insM1C31 ;
lookup _insM1C32 { sub  @Vright  by  uni1C32  @Vright ; } _insM1C32 ;
lookup _insM1C33 { sub  @Vright  by  uni1C33  @Vright ; } _insM1C33 ;
lookup _insM1C36 { sub  @Vright  by  uni1C36  @Vright ; } _insM1C36 ;

lookup _insM1C2D_R { sub  @Vright  by  uni1C2D  @Ran  @Vright ; } _insM1C2D_R ;
lookup _insM1C2E_R { sub  @Vright  by  uni1C2E  @Ran  @Vright ; } _insM1C2E_R ;
lookup _insM1C2F_R { sub  @Vright  by  uni1C2F  @Ran  @Vright ; } _insM1C2F_R ;
lookup _insM1C30_R { sub  @Vright  by  uni1C30  @Ran  @Vright ; } _insM1C30_R ;
lookup _insM1C31_R { sub  @Vright  by  uni1C31  @Ran  @Vright ; } _insM1C31_R ;
lookup _insM1C32_R { sub  @Vright  by  uni1C32  @Ran  @Vright ; } _insM1C32_R ;
lookup _insM1C33_R { sub  @Vright  by  uni1C33  @Ran  @Vright ; } _insM1C33_R ;

lookup _delMark {
	sub  @Vright  @Mtop  @Ran  by  @Vright ;
	sub  @Vright  @Mtop        by  @Vright ; 
} _delMark ;

# I'm not sure that it's really necessary to include the consonant and nukta in the context
# of these rules, but it feels safer.

@ConsOrN = [ @ConsAll  @N ];

lookup Reorder_VrtMt {
  # We should be able to use the following statement and remove the rules with the
  # nuktas, but that seemed to break the entire lookup. Instead I just merged the
  # consonants and nukta into one class.
	#lookupflag UseMarkFilteringSet @N ;
	
	# C V M R  ->  C M R V M R  ->  C M R V
	sub @ConsOrN      @Vright' lookup _insM1C2D_R  uni1C2D'  @Ran' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C2E_R  uni1C2E'  @Ran' lookup _delMark;
	sub @ConsOrN      @Vright' lookup _insM1C2F_R  uni1C2F'  @Ran' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C30_R  uni1C30'  @Ran' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C31_R  uni1C31'  @Ran' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C32_R  uni1C32'  @Ran' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C33_R  uni1C33'  @Ran' lookup _delMark ;
	
	# C N V M R  ->  C N M R V M R  ->  C N M R V
#	sub @ConsAll  @N  @Vright' lookup _insM1C2D_R  uni1C2D'  @Ran' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C2E_R  uni1C2E'  @Ran' lookup _delMark;
#	sub @ConsAll  @N  @Vright' lookup _insM1C2F_R  uni1C2F'  @Ran' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C30_R  uni1C30'  @Ran' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C31_R  uni1C31'  @Ran' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C32_R  uni1C32'  @Ran' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C33_R  uni1C33'  @Ran' lookup _delMark ;

	# C V M  ->  C M V M  ->  C M V
	sub @ConsOrN      @Vright' lookup _insM1C2D  uni1C2D' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C2E  uni1C2E' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C2F  uni1C2F' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C30  uni1C30' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C31  uni1C31' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C32  uni1C32' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C33  uni1C33' lookup _delMark ;
	sub @ConsOrN      @Vright' lookup _insM1C36  @Ran'    lookup _delMark ;
	
	# C N V M  ->  C N M V M  ->  C N M V
#	sub @ConsAll  @N  @Vright' lookup _insM1C2D  uni1C2D' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C2E  uni1C2E' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C2F  uni1C2F' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C30  uni1C30' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C31  uni1C31' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C32  uni1C32' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C33  uni1C33' lookup _delMark ;
#	sub @ConsAll  @N  @Vright' lookup _insM1C36  @Ran'    lookup _delMark ;
	
} Reorder_VrtMt ;


#--- Delete bogus null glyph that was used as a kludge ---

# They only occur at the end of syllables, after cons ligatures + nuktas + top-left vowel.

##@AnyGlyph = [ space  @ConsAll  @Vright  uni1C34  @Left ] ; - not used

@RaYaLigs = [ @BasePlusRa  @BasePlusYa  @BasePlusRaYa ] ;

lookup DeleteBogusNull {

	lookupflag IgnoreMarks ;
		sub  @RaYaLigs  @BogusNull  by  @RaYaLigs ;
		
} DeleteBogusNull ;


#--- Vowel-sign-I + Kang ligature ---

lookup SignIKang {
	lookupflag IgnoreMarks;
		sub uni1C35  uni1C27  by   uni1C271C35 ;  # note that they have been reordered

} SignIKang ;




#********************************************
# Positioning lookups
#

markClass uni1C37 <anchor -409 -180> @_N;

lookup InDesignKludges {
	pos base uni1C19  <anchor 636 -160> mark @_N  <anchor 570 750> mark @_U ;
	pos base uni1C1B  <anchor 564 -214> mark @_N  <anchor 564 650> mark @_U ;
	
	pos base uni1C001C25  <anchor 704 -220> mark @_N  <anchor 810 680> mark @_U ;
	pos base uni1C031C25  <anchor 583 -240> mark @_N  <anchor 568 680> mark @_U ;
	pos base uni1C1D1C25  <anchor 530 -240> mark @_N  <anchor 512 680> mark @_U ;
	
} InDesignKludges ;


lookup AttachMarks {
	lookupflag 0;
		pos base @U mark @_U ;
		pos base @L mark @_L ;
} AttachMarks ;

lookup AttachNMarks {
	lookupflag IgnoreMarks;  # ignore intervening nukta
		pos base @U mark @_U ;
} AttachNMarks ;

lookup AttachMarks2 {
	lookupflag 0;
		pos mark @U_MarkBase mark @_U ;
		pos mark @L_MarkBase mark @_L ;    # attach 1C2C to nukta
} AttachMarks2 ;


#--- Kludge to handle nukta + lower diacritic ---

# Normally the 1C2C diacritic would attach to the lower nukta.  That doesn't work
# presumably because of the reordering that was needed to create the base ligature
# (pulling the nukta out from between the base and the ra/ya).
# So we just shift the diacritic down instead of attaching it.

lookup ShiftNuqta1C2C {

	lookupflag 0;
		pos  @RaYaLigs  @N  uni1C2C' <0 -380 0 0> ;
		
} ShiftNuqta1C2C ;


#************************************************************
# GSUB features                                             *
#************************************************************

feature ccmp {  # Glyph Composition/Decomposition

    lookup FontCheck ;

		lookup VtlMarkLig ;  # do before built-in OT reordering
		
		lookup Reorder_CryNVK ;  # InDesign kludge
		
} ccmp ;


feature clig {  # Contextual Ligatures 

		lookup RaYaLigatures ;
		
		# Reordering that is not handled in InDesign:
		####lookup InDesignReordering;
		
		lookup Reorder_CryNVR ;
		lookup Reorder_CryNV ;
		lookup Reorder_CryNV_delV ;
		
		lookup Reorder_VrtMt ;
		
		lookup DeleteBogusNull ;

		lookup SignIKang ;
		
} clig ;


#************************************************************
# GPOS features                                             *
#************************************************************

feature mark {

	lookup InDesignKludges ;

	lookup AttachMarks ;
	lookup AttachNMarks ;
	lookup AttachMarks2 ;
	
} mark ;


feature dist {

	lookup ShiftNuqta1C2C ;
	
} dist ;

